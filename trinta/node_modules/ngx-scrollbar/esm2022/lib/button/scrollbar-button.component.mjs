import { Component, Input, inject, effect, runInInjectionContext, Injector, ChangeDetectionStrategy } from '@angular/core';
import { tap, delay, merge, switchMap, fromEvent, takeUntil, interval, takeWhile, animationFrameScheduler } from 'rxjs';
import { enableSelection, preventSelection, stopPropagation } from '../utils/common';
import { PointerEventsAdapter } from '../utils/pointer-events-adapter';
import * as i0 from "@angular/core";
export class ScrollbarButton extends PointerEventsAdapter {
    constructor() {
        super(...arguments);
        this.injector = inject(Injector);
        this.afterFirstClickDelay = 120;
        this.firstClickDuration = 100;
        this.scrollBy = 50;
        this.onGoingScrollBy = 12;
        // canScroll function can work for y-axis and x-axis for both LTR and RTL directions
        this.canScrollFunc = {
            forward: (scrollOffset, scrollMax) => scrollOffset < scrollMax,
            backward: (scrollOffset) => scrollOffset > 0
        };
        this.scrollStepFunc = {
            forward: (scrollBy, offset) => offset + scrollBy,
            backward: (scrollBy, offset) => offset - scrollBy
        };
        this.horizontalScrollStepFunc = {
            rtl: {
                forward: (scrollBy, offset, scrollMax) => scrollMax - offset - scrollBy,
                backward: (scrollBy, offset, scrollMax) => scrollMax - offset + scrollBy
            },
            ltr: this.scrollStepFunc
        };
    }
    get pointerEvents() {
        const pointerDown$ = fromEvent(this.nativeElement, 'pointerdown').pipe(stopPropagation(), preventSelection(this.document));
        const pointerUp$ = fromEvent(this.document, 'pointerup', { passive: true }).pipe(enableSelection(this.document));
        const pointerLeave$ = fromEvent(this.nativeElement, 'pointerleave', { passive: true });
        // Combine pointerup and pointerleave events into one stream
        const pointerUpOrLeave$ = merge(pointerUp$, pointerLeave$);
        return pointerDown$.pipe(switchMap(() => this.firstScrollStep().pipe(delay(this.afterFirstClickDelay), switchMap(() => this.onOngoingPointerdown()), takeUntil(pointerUpOrLeave$))));
    }
    ngOnInit() {
        // Get the canScroll function according to scroll direction (forward/backward)
        this.canScroll = this.canScrollFunc[this.scrollDirection];
        if (this.control.axis === 'x') {
            runInInjectionContext(this.injector, () => {
                effect(() => {
                    const dir = this.cmp.direction();
                    // Get the nextStep function according to scroll direction (forward/backward) and layout direction (LTR/RTL)
                    this.nextStep = this.horizontalScrollStepFunc[dir][this.scrollDirection];
                });
            });
        }
        else {
            // Get the nextStep function according to scroll direction (forward/backward)
            this.nextStep = this.scrollStepFunc[this.scrollDirection];
        }
    }
    firstScrollStep() {
        const value = this.nextStep(this.scrollBy, this.control.viewportScrollOffset, this.control.viewportScrollMax);
        return this.control.scrollTo(value, this.firstClickDuration);
    }
    onGoingScrollStep() {
        const scrollMax = this.control.viewportScrollMax;
        const value = this.nextStep(this.onGoingScrollBy, this.control.viewportScrollOffset, scrollMax);
        this.control.instantScrollTo(value, scrollMax);
    }
    onOngoingPointerdown() {
        return interval(0, animationFrameScheduler).pipe(takeWhile(() => this.canScroll(this.control.viewportScrollOffset, this.control.viewportScrollMax)), tap(() => this.onGoingScrollStep()));
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.3.3", ngImport: i0, type: ScrollbarButton, deps: null, target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "17.3.3", type: ScrollbarButton, isStandalone: true, selector: "button[scrollbarButton]", inputs: { scrollbarButton: "scrollbarButton", scrollDirection: "scrollDirection" }, usesInheritance: true, ngImport: i0, template: "<div class=\"ng-scrollbar-button-icon\">\r\n  <svg viewBox=\"0 0 512 512\"\r\n       xmlns=\"http://www.w3.org/2000/svg\">\r\n    <path\r\n      d=\"M413.1,327.3l-1.8-2.1l-136-156.5c-4.6-5.3-11.5-8.6-19.2-8.6c-7.7,0-14.6,3.4-19.2,8.6L101,324.9l-2.3,2.6  C97,330,96,333,96,336.2c0,8.7,7.4,15.8,16.6,15.8v0h286.8v0c9.2,0,16.6-7.1,16.6-15.8C416,332.9,414.9,329.8,413.1,327.3z\"/>\r\n  </svg>\r\n</div>\r\n", styles: [":host{--scrollbar-button-size: 20px;position:relative;border:none;margin:0;padding:0;border-radius:0;appearance:none;background-color:var(--scrollbar-button-color)}:host svg{fill:var(--scrollbar-button-fill)}:host:hover{background:var(--scrollbar-button-hover-color)}:host:hover svg{fill:var(--scrollbar-button-hover-fill)}:host:active{background:var(--scrollbar-button-active-color)}:host:active svg{fill:var(--scrollbar-button-active-fill)}:host[scrollbarButton=top],:host[scrollbarButton=start]{order:1}:host[scrollbarButton=bottom],:host[scrollbarButton=end]{order:3}:host[scrollbarButton=top],:host[scrollbarButton=bottom]{width:100%;height:var(--scrollbar-button-size)}:host[scrollbarButton=start],:host[scrollbarButton=end]{width:var(--scrollbar-button-size);height:100%}:host[scrollbarButton=bottom]{--_button-rotate: 180deg}:host[scrollbarButton=start]{--_button-rotate: -90deg}:host[scrollbarButton=start] .ng-scrollbar-button-icon{writing-mode:vertical-lr}:host[scrollbarButton=end]{--_button-rotate: 90deg}:host[scrollbarButton=end] .ng-scrollbar-button-icon{writing-mode:vertical-rl}.ng-scrollbar-button-icon{rotate:var(--_button-rotate);display:flex;place-content:center;place-items:center;width:100%;height:100%}\n"], changeDetection: i0.ChangeDetectionStrategy.OnPush }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.3.3", ngImport: i0, type: ScrollbarButton, decorators: [{
            type: Component,
            args: [{ standalone: true, selector: 'button[scrollbarButton]', changeDetection: ChangeDetectionStrategy.OnPush, template: "<div class=\"ng-scrollbar-button-icon\">\r\n  <svg viewBox=\"0 0 512 512\"\r\n       xmlns=\"http://www.w3.org/2000/svg\">\r\n    <path\r\n      d=\"M413.1,327.3l-1.8-2.1l-136-156.5c-4.6-5.3-11.5-8.6-19.2-8.6c-7.7,0-14.6,3.4-19.2,8.6L101,324.9l-2.3,2.6  C97,330,96,333,96,336.2c0,8.7,7.4,15.8,16.6,15.8v0h286.8v0c9.2,0,16.6-7.1,16.6-15.8C416,332.9,414.9,329.8,413.1,327.3z\"/>\r\n  </svg>\r\n</div>\r\n", styles: [":host{--scrollbar-button-size: 20px;position:relative;border:none;margin:0;padding:0;border-radius:0;appearance:none;background-color:var(--scrollbar-button-color)}:host svg{fill:var(--scrollbar-button-fill)}:host:hover{background:var(--scrollbar-button-hover-color)}:host:hover svg{fill:var(--scrollbar-button-hover-fill)}:host:active{background:var(--scrollbar-button-active-color)}:host:active svg{fill:var(--scrollbar-button-active-fill)}:host[scrollbarButton=top],:host[scrollbarButton=start]{order:1}:host[scrollbarButton=bottom],:host[scrollbarButton=end]{order:3}:host[scrollbarButton=top],:host[scrollbarButton=bottom]{width:100%;height:var(--scrollbar-button-size)}:host[scrollbarButton=start],:host[scrollbarButton=end]{width:var(--scrollbar-button-size);height:100%}:host[scrollbarButton=bottom]{--_button-rotate: 180deg}:host[scrollbarButton=start]{--_button-rotate: -90deg}:host[scrollbarButton=start] .ng-scrollbar-button-icon{writing-mode:vertical-lr}:host[scrollbarButton=end]{--_button-rotate: 90deg}:host[scrollbarButton=end] .ng-scrollbar-button-icon{writing-mode:vertical-rl}.ng-scrollbar-button-icon{rotate:var(--_button-rotate);display:flex;place-content:center;place-items:center;width:100%;height:100%}\n"] }]
        }], propDecorators: { scrollbarButton: [{
                type: Input,
                args: [{ required: true }]
            }], scrollDirection: [{
                type: Input,
                args: [{ required: true }]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Nyb2xsYmFyLWJ1dHRvbi5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtc2Nyb2xsYmFyL3NyYy9saWIvYnV0dG9uL3Njcm9sbGJhci1idXR0b24uY29tcG9uZW50LnRzIiwiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LXNjcm9sbGJhci9zcmMvbGliL2J1dHRvbi9zY3JvbGxiYXItYnV0dG9uLmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsS0FBSyxFQUNMLE1BQU0sRUFDTixNQUFNLEVBQ04scUJBQXFCLEVBRXJCLFFBQVEsRUFDUix1QkFBdUIsRUFDeEIsTUFBTSxlQUFlLENBQUM7QUFFdkIsT0FBTyxFQUVMLEdBQUcsRUFDSCxLQUFLLEVBQ0wsS0FBSyxFQUNMLFNBQVMsRUFDVCxTQUFTLEVBQ1QsU0FBUyxFQUNULFFBQVEsRUFDUixTQUFTLEVBQ1QsdUJBQXVCLEVBQ3hCLE1BQU0sTUFBTSxDQUFDO0FBQ2QsT0FBTyxFQUFFLGVBQWUsRUFBRSxnQkFBZ0IsRUFBRSxlQUFlLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNyRixPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQzs7QUFTdkUsTUFBTSxPQUFPLGVBQWdCLFNBQVEsb0JBQW9CO0lBUHpEOztRQVNtQixhQUFRLEdBQWEsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBSy9DLHlCQUFvQixHQUFXLEdBQUcsQ0FBQztRQUNuQyx1QkFBa0IsR0FBVyxHQUFHLENBQUM7UUFDakMsYUFBUSxHQUFXLEVBQUUsQ0FBQztRQUN0QixvQkFBZSxHQUFXLEVBQUUsQ0FBQztRQUtyQyxvRkFBb0Y7UUFDbkUsa0JBQWEsR0FBb0Y7WUFDaEgsT0FBTyxFQUFFLENBQUMsWUFBb0IsRUFBRSxTQUFpQixFQUFXLEVBQUUsQ0FBQyxZQUFZLEdBQUcs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Y2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIENvbXBvbmVudCxcclxuICBJbnB1dCxcclxuICBpbmplY3QsXHJcbiAgZWZmZWN0LFxyXG4gIHJ1bkluSW5qZWN0aW9uQ29udGV4dCxcclxuICBPbkluaXQsXHJcbiAgSW5qZWN0b3IsXHJcbiAgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3lcclxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgRGlyZWN0aW9uIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL2JpZGknO1xyXG5pbXBvcnQge1xyXG4gIE9ic2VydmFibGUsXHJcbiAgdGFwLFxyXG4gIGRlbGF5LFxyXG4gIG1lcmdlLFxyXG4gIHN3aXRjaE1hcCxcclxuICBmcm9tRXZlbnQsXHJcbiAgdGFrZVVudGlsLFxyXG4gIGludGVydmFsLFxyXG4gIHRha2VXaGlsZSxcclxuICBhbmltYXRpb25GcmFtZVNjaGVkdWxlclxyXG59IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBlbmFibGVTZWxlY3Rpb24sIHByZXZlbnRTZWxlY3Rpb24sIHN0b3BQcm9wYWdhdGlvbiB9IGZyb20gJy4uL3V0aWxzL2NvbW1vbic7XHJcbmltcG9ydCB7IFBvaW50ZXJFdmVudHNBZGFwdGVyIH0gZnJvbSAnLi4vdXRpbHMvcG9pbnRlci1ldmVudHMtYWRhcHRlcic7XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICBzdGFuZGFsb25lOiB0cnVlLFxyXG4gIHNlbGVjdG9yOiAnYnV0dG9uW3Njcm9sbGJhckJ1dHRvbl0nLFxyXG4gIHRlbXBsYXRlVXJsOiAnLi9zY3JvbGxiYXItYnV0dG9uLmNvbXBvbmVudC5odG1sJyxcclxuICBzdHlsZVVybDogJy4vc2Nyb2xsYmFyLWJ1dHRvbi5jb21wb25lbnQuc2NzcycsXHJcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2hcclxufSlcclxuZXhwb3J0IGNsYXNzIFNjcm9sbGJhckJ1dHRvbiBleHRlbmRzIFBvaW50ZXJFdmVudHNBZGFwdGVyIGltcGxlbWVudHMgT25Jbml0IHtcclxuXHJcbiAgcHJpdmF0ZSByZWFkb25seSBpbmplY3RvcjogSW5qZWN0b3IgPSBpbmplY3QoSW5qZWN0b3IpO1xyXG5cclxuICBASW5wdXQoeyByZXF1aXJlZDogdHJ1ZSB9KSBzY3JvbGxiYXJCdXR0b246ICd0b3AnIHwgJ2JvdHRvbScgfCAnc3RhcnQnIHwgJ2VuZCc7XHJcbiAgQElucHV0KHsgcmVxdWlyZWQ6IHRydWUgfSkgc2Nyb2xsRGlyZWN0aW9uOiAnZm9yd2FyZCcgfCAnYmFja3dhcmQnO1xyXG5cclxuICBwcml2YXRlIGFmdGVyRmlyc3RDbGlja0RlbGF5OiBudW1iZXIgPSAxMjA7XHJcbiAgcHJpdmF0ZSBmaXJzdENsaWNrRHVyYXRpb246IG51bWJlciA9IDEwMDtcclxuICBwcml2YXRlIHNjcm9sbEJ5OiBudW1iZXIgPSA1MDtcclxuICBwcml2YXRlIG9uR29pbmdTY3JvbGxCeTogbnVtYmVyID0gMTI7XHJcblxyXG4gIHByaXZhdGUgbmV4dFN0ZXA6IChzY3JvbGxCeTogbnVtYmVyLCBvZmZzZXQ6IG51bWJlciwgc2Nyb2xsTWF4OiBudW1iZXIpID0+IG51bWJlcjtcclxuICBwcml2YXRlIGNhblNjcm9sbDogKG9mZnNldDogbnVtYmVyLCBzY3JvbGxNYXg6IG51bWJlcikgPT4gYm9vbGVhbjtcclxuXHJcbiAgLy8gY2FuU2Nyb2xsIGZ1bmN0aW9uIGNhbiB3b3JrIGZvciB5LWF4aXMgYW5kIHgtYXhpcyBmb3IgYm90aCBMVFIgYW5kIFJUTCBkaXJlY3Rpb25zXHJcbiAgcHJpdmF0ZSByZWFkb25seSBjYW5TY3JvbGxGdW5jOiBSZWNvcmQ8J2ZvcndhcmQnIHwgJ2JhY2t3YXJkJywgKG9mZnNldDogbnVtYmVyLCBzY3JvbGxNYXg/OiBudW1iZXIpID0+IGJvb2xlYW4+ID0ge1xyXG4gICAgZm9yd2FyZDogKHNjcm9sbE9mZnNldDogbnVtYmVyLCBzY3JvbGxNYXg6IG51bWJlcik6IGJvb2xlYW4gPT4gc2Nyb2xsT2Zmc2V0IDwgc2Nyb2xsTWF4LFxyXG4gICAgYmFja3dhcmQ6IChzY3JvbGxPZmZzZXQ6IG51bWJlcik6IGJvb2xlYW4gPT4gc2Nyb2xsT2Zmc2V0ID4gMFxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzY3JvbGxTdGVwRnVuYzogUmVjb3JkPCdmb3J3YXJkJyB8ICdiYWNrd2FyZCcsIChzY3JvbGxCeTogbnVtYmVyLCBvZmZzZXQ6IG51bWJlciwgc2Nyb2xsTWF4OiBudW1iZXIpID0+IG51bWJlcj4gPSB7XHJcbiAgICBmb3J3YXJkOiAoc2Nyb2xsQnk6IG51bWJlciwgb2Zmc2V0OiBudW1iZXIpID0+IG9mZnNldCArIHNjcm9sbEJ5LFxyXG4gICAgYmFja3dhcmQ6IChzY3JvbGxCeTogbnVtYmVyLCBvZmZzZXQ6IG51bWJlcikgPT4gb2Zmc2V0IC0gc2Nyb2xsQnlcclxuICB9O1xyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IGhvcml6b250YWxTY3JvbGxTdGVwRnVuYzogUmVjb3JkPCdsdHInIHwgJ3J0bCcsIHR5cGVvZiB0aGlzLnNjcm9sbFN0ZXBGdW5jPiA9IHtcclxuICAgIHJ0bDoge1xyXG4gICAgICBmb3J3YXJkOiAoc2Nyb2xsQnk6IG51bWJlciwgb2Zmc2V0OiBudW1iZXIsIHNjcm9sbE1heDogbnVtYmVyKSA9PiBzY3JvbGxNYXggLSBvZmZzZXQgLSBzY3JvbGxCeSxcclxuICAgICAgYmFja3dhcmQ6IChzY3JvbGxCeTogbnVtYmVyLCBvZmZzZXQ6IG51bWJlciwgc2Nyb2xsTWF4OiBudW1iZXIpID0+IHNjcm9sbE1heCAtIG9mZnNldCArIHNjcm9sbEJ5XHJcbiAgICB9LFxyXG4gICAgbHRyOiB0aGlzLnNjcm9sbFN0ZXBGdW5jXHJcbiAgfVxyXG5cclxuICBnZXQgcG9pbnRlckV2ZW50cygpOiBPYnNlcnZhYmxlPFBvaW50ZXJFdmVudD4ge1xyXG4gICAgY29uc3QgcG9pbnRlckRvd24kOiBPYnNlcnZhYmxlPFBvaW50ZXJFdmVudD4gPSBmcm9tRXZlbnQ8UG9pbnRlckV2ZW50Pih0aGlzLm5hdGl2ZUVsZW1lbnQsICdwb2ludGVyZG93bicpLnBpcGUoXHJcbiAgICAgIHN0b3BQcm9wYWdhdGlvbigpLFxyXG4gICAgICBwcmV2ZW50U2VsZWN0aW9uKHRoaXMuZG9jdW1lbnQpXHJcbiAgICApO1xyXG4gICAgY29uc3QgcG9pbnRlclVwJDogT2JzZXJ2YWJsZTxQb2ludGVyRXZlbnQ+ID0gZnJvbUV2ZW50PFBvaW50ZXJFdmVudD4odGhpcy5kb2N1bWVudCwgJ3BvaW50ZXJ1cCcsIHsgcGFzc2l2ZTogdHJ1ZSB9KS5waXBlKFxyXG4gICAgICBlbmFibGVTZWxlY3Rpb24odGhpcy5kb2N1bWVudClcclxuICAgICk7XHJcblxyXG4gICAgY29uc3QgcG9pbnRlckxlYXZlJDogT2JzZXJ2YWJsZTxQb2ludGVyRXZlbnQ+ID0gZnJvbUV2ZW50PFBvaW50ZXJFdmVudD4odGhpcy5uYXRpdmVFbGVtZW50LCAncG9pbnRlcmxlYXZlJywgeyBwYXNzaXZlOiB0cnVlIH0pO1xyXG5cclxuICAgIC8vIENvbWJpbmUgcG9pbnRlcnVwIGFuZCBwb2ludGVybGVhdmUgZXZlbnRzIGludG8gb25lIHN0cmVhbVxyXG4gICAgY29uc3QgcG9pbnRlclVwT3JMZWF2ZSQ6IE9ic2VydmFibGU8UG9pbnRlckV2ZW50PiA9IG1lcmdlKHBvaW50ZXJVcCQsIHBvaW50ZXJMZWF2ZSQpO1xyXG5cclxuICAgIHJldHVybiBwb2ludGVyRG93biQucGlwZShcclxuICAgICAgc3dpdGNoTWFwKCgpID0+IHRoaXMuZmlyc3RTY3JvbGxTdGVwKCkucGlwZShcclxuICAgICAgICBkZWxheSh0aGlzLmFmdGVyRmlyc3RDbGlja0RlbGF5KSxcclxuICAgICAgICBzd2l0Y2hNYXAoKCkgPT4gdGhpcy5vbk9uZ29pbmdQb2ludGVyZG93bigpKSxcclxuICAgICAgICB0YWtlVW50aWwocG9pbnRlclVwT3JMZWF2ZSQpLFxyXG4gICAgICApKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIG5nT25Jbml0KCk6IHZvaWQge1xyXG4gICAgLy8gR2V0IHRoZSBjYW5TY3JvbGwgZnVuY3Rpb24gYWNjb3JkaW5nIHRvIHNjcm9sbCBkaXJlY3Rpb24gKGZvcndhcmQvYmFja3dhcmQpXHJcbiAgICB0aGlzLmNhblNjcm9sbCA9IHRoaXMuY2FuU2Nyb2xsRnVuY1t0aGlzLnNjcm9sbERpcmVjdGlvbl07XHJcblxyXG4gICAgaWYgKHRoaXMuY29udHJvbC5heGlzID09PSAneCcpIHtcclxuICAgICAgcnVuSW5JbmplY3Rpb25Db250ZXh0KHRoaXMuaW5qZWN0b3IsICgpID0+IHtcclxuICAgICAgICBlZmZlY3QoKCkgPT4ge1xyXG4gICAgICAgICAgY29uc3QgZGlyOiBEaXJlY3Rpb24gPSB0aGlzLmNtcC5kaXJlY3Rpb24oKTtcclxuICAgICAgICAgIC8vIEdldCB0aGUgbmV4dFN0ZXAgZnVuY3Rpb24gYWNjb3JkaW5nIHRvIHNjcm9sbCBkaXJlY3Rpb24gKGZvcndhcmQvYmFja3dhcmQpIGFuZCBsYXlvdXQgZGlyZWN0aW9uIChMVFIvUlRMKVxyXG4gICAgICAgICAgdGhpcy5uZXh0U3RlcCA9IHRoaXMuaG9yaXpvbnRhbFNjcm9sbFN0ZXBGdW5jW2Rpcl1bdGhpcy5zY3JvbGxEaXJlY3Rpb25dO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8vIEdldCB0aGUgbmV4dFN0ZXAgZnVuY3Rpb24gYWNjb3JkaW5nIHRvIHNjcm9sbCBkaXJlY3Rpb24gKGZvcndhcmQvYmFja3dhcmQpXHJcbiAgICAgIHRoaXMubmV4dFN0ZXAgPSB0aGlzLnNjcm9sbFN0ZXBGdW5jW3RoaXMuc2Nyb2xsRGlyZWN0aW9uXTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgZmlyc3RTY3JvbGxTdGVwKCk6IE9ic2VydmFibGU8dm9pZD4ge1xyXG4gICAgY29uc3QgdmFsdWU6IG51bWJlciA9IHRoaXMubmV4dFN0ZXAodGhpcy5zY3JvbGxCeSwgdGhpcy5jb250cm9sLnZpZXdwb3J0U2Nyb2xsT2Zmc2V0LCB0aGlzLmNvbnRyb2wudmlld3BvcnRTY3JvbGxNYXgpO1xyXG4gICAgcmV0dXJuIHRoaXMuY29udHJvbC5zY3JvbGxUbyh2YWx1ZSwgdGhpcy5maXJzdENsaWNrRHVyYXRpb24pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBvbkdvaW5nU2Nyb2xsU3RlcCgpOiB2b2lkIHtcclxuICAgIGNvbnN0IHNjcm9sbE1heDogbnVtYmVyID0gdGhpcy5jb250cm9sLnZpZXdwb3J0U2Nyb2xsTWF4O1xyXG4gICAgY29uc3QgdmFsdWU6IG51bWJlciA9IHRoaXMubmV4dFN0ZXAodGhpcy5vbkdvaW5nU2Nyb2xsQnksIHRoaXMuY29udHJvbC52aWV3cG9ydFNjcm9sbE9mZnNldCwgc2Nyb2xsTWF4KTtcclxuICAgIHRoaXMuY29udHJvbC5pbnN0YW50U2Nyb2xsVG8odmFsdWUsIHNjcm9sbE1heCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIG9uT25nb2luZ1BvaW50ZXJkb3duKCk6IE9ic2VydmFibGU8UG9pbnRlckV2ZW50PiB7XHJcbiAgICByZXR1cm4gaW50ZXJ2YWwoMCwgYW5pbWF0aW9uRnJhbWVTY2hlZHVsZXIpLnBpcGUoXHJcbiAgICAgIHRha2VXaGlsZSgoKSA9PiB0aGlzLmNhblNjcm9sbCh0aGlzLmNvbnRyb2wudmlld3BvcnRTY3JvbGxPZmZzZXQsIHRoaXMuY29udHJvbC52aWV3cG9ydFNjcm9sbE1heCkpLFxyXG4gICAgICB0YXAoKCkgPT4gdGhpcy5vbkdvaW5nU2Nyb2xsU3RlcCgpKVxyXG4gICAgKSBhcyBPYnNlcnZhYmxlPFBvaW50ZXJFdmVudD47XHJcbiAgfVxyXG59XHJcbiIsIjxkaXYgY2xhc3M9XCJuZy1zY3JvbGxiYXItYnV0dG9uLWljb25cIj5cclxuICA8c3ZnIHZpZXdCb3g9XCIwIDAgNTEyIDUxMlwiXHJcbiAgICAgICB4bWxucz1cImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnXCI+XHJcbiAgICA8cGF0aFxyXG4gICAgICBkPVwiTTQxMy4xLDMyNy4zbC0xLjgtMi4xbC0xMzYtMTU2LjVjLTQuNi01LjMtMTEuNS04LjYtMTkuMi04LjZjLTcuNywwLTE0LjYsMy40LTE5LjIsOC42TDEwMSwzMjQuOWwtMi4zLDIuNiAgQzk3LDMzMCw5NiwzMzMsOTYsMzM2LjJjMCw4LjcsNy40LDE1LjgsMTYuNiwxNS44djBoMjg2Ljh2MGM5LjIsMCwxNi42LTcuMSwxNi42LTE1LjhDNDE2LDMzMi45LDQxNC45LDMyOS44LDQxMy4xLDMyNy4zelwiLz5cclxuICA8L3N2Zz5cclxuPC9kaXY+XHJcbiJdfQ==